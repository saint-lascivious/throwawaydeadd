#!/usr/bin/env bash

# throwawaydeadd
# saint-lascivious (Hayden Pearce) Â©2023

# GNU General Public License Version 3

script_name="$(basename "$0")"  # MUST NOT edit
service_name="${script_name%.*}"

script_dir="/etc/scripts"
if [ -f "${script_dir}/${service_name}.conf" ]; then
    # shellcheck source=/dev/null
    . "${script_dir}/${service_name}.conf"
fi

master_is_backup_active="${MASTER_IS_BACKUP_ACTIVE:-restart}"
master_is_backup_inactive="${MASTER_IS_BACKUP_INACTIVE:-start}"

backup_is_backup_active="${BACKUP_IS_BACKUP_ACTIVE:-restart}"
backup_is_backup_inactive="${BACKUP_IS_BACKUP_INACTIVE:-start}"

master_is_master_active="${MASTER_IS_MASTER_ACTIVE:-restart}"
master_is_master_inactive="${MASTER_IS_MASTER_INACTIVE:-start}"

backup_is_master_active="${BACKUP_IS_MASTER_ACTIVE:-restart}"
backup_is_master_inactive="${BACKUP_IS_MASTER_INACTIVE:-start}"

master_flag_file="${script_dir}/.is_master_server"  # Master server trigger file
max_state_age="4"  # Time in seconds before saved state is considered stale
state_dir="/var/log"  # Directory in which *.lock and *.state files are kept

is_master="${IS_MASTER:-false}"  # SHOULD NOT edit

vrrp_function="${script_name##*.}"  # MUST NOT edit
lock_file="${state_dir}/${service_name}-${vrrp_function}.lock"
state_file="${state_dir}/${service_name}.state"

systemctl_wrapper() {
    systemctl_action="$1"
    case $systemctl_action in
        "disable"|"enable"|"reenable"|"reload"|"reload-or-restart"|"reset-failed"|"restart"|"start"|"stop")
            if systemctl "${systemctl_action}" "${service_name}" > /dev/null; then
                exit 0
            else
                exit 1
            fi
        ;;
        ""|"none")
            exit 0
        ;;
        *)
            exit 1
        ;;
    esac
}

exec 9>"$lock_file"
if flock -n 9; then
    if command -v systemctl > /dev/null; then
        service_state="$(systemctl is-active "$service_name")"
    fi
    case $vrrp_function in
        "check"|"CHECK")
            current_time="$(date +%s)"
            state_last_modified="$(stat -c %Y "${state_file}")"
            state_age="$(("${current_time}" - "${state_last_modified}"))"
            if [ -f "${state_file}" ] && [ "${state_age}" -le "${max_state_age}" ]; then
                saved_state="$(cat "${state_file}")"
                if [ "${saved_state}" = "active" ]; then
                    exit 0
                else
                    exit 1
                fi
            else
                exec 8>"$state_file"
                if flock -n 8; then
                    echo "${service_state}" > "${state_file}"
                    if [ "${service_state}" = "active" ]; then
                        exit 0
                    else
                        exit 1
                    fi
                fi
            fi
        ;;
        "notify"|"NOTIFY")
            vrrp_state="$3"
            if [ -f "$master_flag_file" ]; then
                is_master="true"
            fi
            case $vrrp_state in
                "backup"|"BACKUP")
                    if [ "$is_master" = "true" ]; then
                        case $service_state in
                            "active")
                                systemctl_wrapper "${master_is_backup_active}"
                            ;;
                            "inactive")
                                systemctl_wrapper "${master_is_backup_inactive}"
                            ;;
                        esac
                    else
                        case $service_state in
                            "active")
                                systemctl_wrapper "${backup_is_backup_active}"
                            ;;
                            "inactive")
                                systemctl_wrapper "${backup_is_backup_inactive}"
                            ;;
                        esac
                    fi
                ;;
                "master"|"MASTER")
                    if [ "$is_master" = "true" ]; then
                        case $service_state in
                            "active")
                                systemctl_wrapper "${master_is_master_active}"
                            ;;
                            "inactive")
                                systemctl_wrapper "${master_is_master_inactive}"
                            ;;
                        esac
                    else
                        case $service_state in
                            "active")
                                systemctl_wrapper "${backup_is_master_active}"
                            ;;
                            "inactive")
                                systemctl_wrapper "${backup_is_master_inactive}"
                            ;;
                        esac
                    fi
                ;;
            esac
        ;;
    esac
fi
